<?php
/**
 * @file
 * Drupal database deploy module
 *
 * Make deployment via git much easier.
 */
 
/**
 * Implements hook_node_update().
 */
function drupal_deploy_node_update($node) {
  $op = 'node_update';
  drupal_deploy_save_transaction('node', $op, $node);
}

/**
 * Implements hook_node_insert().
 */
function drupal_deploy_node_insert($node) {
  $op = 'node_insert';
  drupal_deploy_save_transaction('node', $op, $node);
}

/**
 * Implements hook_node_delete().
 */
function drupal_deploy_node_delete($node) {
  $op = 'node_delete';
  drupal_deploy_save_transaction('node', $op, $node);
}

/**
 * Implements hook_node_revision_delete().
 */
function drupal_deploy_node_revision_delete($node) {
  $op = 'node_revision_delete';
  drupal_deploy_save_transaction('node', $op, $node);
}

/**
 *
 */
function drupal_deploy_save_transaction($type, $op, $store) {
  $root_dir = variable_get('drupal_deploy_path_to_transations', 'private://drupal_deploy/');

  $type_dir = $root_dir . '/' . $type;

  file_check_directory($type_dir, FILE_CREATE_DIRECTORY);

  $transaction_file = $type_dir . DIRECTORY_SEPARATOR . microtime(TRUE) * 10000;

  $data = array(
    'op' => $op,
    'data' => $store,
  );
  file_unmanaged_save_data(serialize($data), $transaction_file);
}

function drupal_deploy_export_pretty_json($json) {
  $result      = '';
  $pos         = 0;
  $strLen      = strlen($json);
  $indentStr   = '  ';
  $newLine     = "\n";
  $prevChar    = '';
  $outOfQuotes = true;

  for ($i=0; $i<=$strLen; $i++) {
    $char = $json[$i];
    
    if ($char == '"' && $prevChar != '\\') 
    {
      $outOfQuotes = !$outOfQuotes;
    }
    else if(($char == '}' || $char == ']') && $outOfQuotes)
    {
      $result .= $newLine;
      $pos --;
      for ($j = 0; $j < $pos; $j++) {
        $result .= $indentStr;
      }
    }

    $result .= $char;

    if (($char == ',' || $char == '{' || $char == '[') && $outOfQuotes)
    {
      $result .= $newLine;
      if ($char == '{' || $char == '[') {
        $pos ++;
      }

      for ($j = 0; $j < $pos; $j++) {
        $result .= $indentStr;
      }
    }

    $prevChar = $char;
  }

  return $result;
}


if (!defined("JSON_NUMERIC_CHECK")) {
  define("JSON_NUMERIC_CHECK", 32);      // 5.3.3
}

if (!defined("JSON_UNESCAPED_SLASHES")) {
  define("JSON_UNESCAPED_SLASHES", 64);
  define("JSON_HEX_TAG", 1);
  define("JSON_HEX_AMP", 2);
  define("JSON_HEX_APOS", 4);
  define("JSON_HEX_QUOT", 8);
}

function dd_json_encode_pretty_utf8($var, $options=0, $_indent="") {
  global ${'.json_last_error'};
  ${'.json_last_error'} = JSON_ERROR_NONE;
        
  #-- prepare JSON string
  list($_space, $_tab, $_nl) = array(" ", "    $_indent", "\n");
  $json = "$_indent";
  
  if (is_string($var) and is_numeric($var)) {
      echo "convert to int";
      $var = (strpos($var, ".") || strpos($var, "e")) ? floatval($var) : intval($var);
  }else {
    echo " $var is not int";
  }
  
  #-- add array entries
  if (is_array($var) || ($obj=is_object($var))) {
     #-- check if array is associative
     if (!$obj) {
        $keys = array_keys((array)$var);
        $obj = !($keys === array_keys($keys));   // keys must be in 0,1,2,3, ordering, but PHP treats integers==strings otherwise
     }

     #-- concat individual entries
     $empty = 0; $json = "";
     foreach ((array)$var as $i=>$v) {
        $json .= ($empty++ ? ",$_nl" : "")    // comma separators
               . $_tab . ($obj ? ( dd_json_encode_pretty_utf8($i, $options, $_tab) . ":$_space") : "")   // assoc prefix
               . ( dd_json_encode_pretty_utf8($v, $options, $_tab));    // value
     }

     #-- enclose into braces or brackets
     $json = $obj ? "{"."$_nl$json$_nl$_indent}" : "[$_nl$json$_nl$_indent]";
  }

  #-- strings need some care
  elseif (is_string($var)) {
    $rewrite = array(
         "\\" => "\\\\",
         "\"" => "\\\"",
       "\010" => "\\b",
         "\f" => "\\f",
         "\n" => "\\n",
         "\r" => "\\r", 
         "\t" => "\\t",
         "/"  => $options & JSON_UNESCAPED_SLASHES ? "/" : "\\/",
         "<"  => $options & JSON_HEX_TAG  ? "\\u003C" : "<",
         ">"  => $options & JSON_HEX_TAG  ? "\\u003E" : ">",
         "'"  => $options & JSON_HEX_APOS ? "\\u0027" : "'",
         "\"" => $options & JSON_HEX_QUOT ? "\\u0022" : "\"",
         "&"  => $options & JSON_HEX_AMP  ? "\\u0026" : "&",
         '"'  => '\"',
       "\x08" => "\\f",
       "\x0c" => "\\b",
       
     );
    $var = strtr($var, $rewrite);
    if (function_exists("iconv")) {
      $var = preg_replace("/[\\x00-\\x1F\\x7F]/ue", "'\\u'.current(unpack('H*', iconv('UTF-8', 'UCS-2BE', '$0')))", $var);
    }
    $json = '"' . $var . '"';
  }

  #-- basic types
  elseif (is_bool($var)) {
    $json = $var ? "true" : "false";
  }
  elseif ($var === NULL) {
    $json = "null";
  }
  elseif (is_int($var)) {
    $json = '"' . $var . '"';
  }
  elseif (is_float($var)) {
    if (is_nan($var) || is_infinite($var)) {
      ${'.json_last_error'} = JSON_ERROR_INF_OR_NAN;
      return;
    }
    else {
      $json = "$var";
    }
  }

  #-- something went wrong
  else {
    trigger_error("json_encode: don't know what a '" .gettype($var). "' is.", E_USER_WARNING);
    ${'.json_last_error'} = JSON_ERROR_UNSUPPORTED_TYPE;
    return;
  }
  
  #-- done
  return($json);
}

function drupal_deploy_export_save($items, $filename = ''){
  $data = dd_json_encode_pretty_utf8($items);
  if(file_put_contents($filename, $data)){
    drush_log(dt('Exported to file !filename', array('!filename' => $filename)),'ok');
  }
}

/*
 * API Functions
 */

function dde_get_user_name($uid){
  $user = db_fetch_object(db_query("SELECT * FROM {users} WHERE uid=%d", $uid));
  return $user->name;
}

function ddi_get_user_id($name){
  if($user = db_fetch_object(db_query("SELECT * FROM {users} WHERE name='%s'", $name))){
    return $user->uid;
  }
  return 0;
}


function dde_get_format_name($format){
  $format = db_fetch_object(db_query("SELECT * FROM {filter_formats} WHERE format=%d", $format));
  return $format->name;
}

function ddi_get_format_id($format){
  if($format = db_fetch_object(db_query("SELECT * FROM {filter_formats} WHERE name='%s'", $format))){
    return $format->format;
  }else{
    return FILTER_FORMAT_DEFAULT;
  }
}

function dde_menu_alias($path){
  if($alias = db_fetch_object(db_query("SELECT * FROM {url_alias} WHERE src = '%s'", $path))){
    return $alias->dst;
  }
  
  $node_link = explode('/', $path);
  if($node_link[0] == 'node' && is_numeric($node_link[1])){
    $node = db_fetch_object(db_query("SELECT * FROM {node} WHERE nid=%d", $node_link[1]));
    return array(
      'title' => $node->title,
      'type' => $node->type,
      'created' => $node->created,
      'username' => dde_get_user_name($node->uid),
    );
  }
  return $path;
}

function ddi_menu_alias_origin($path){
  if($alias = db_fetch_object(db_query("SELECT * FROM {url_alias} WHERE dst = '%s'", $path))){
    return $alias->src;
  }
  return $path;   
}
